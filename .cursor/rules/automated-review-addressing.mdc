---
description: Automated Review Addressing System â€” PR review batches launch a Cursor Background Agent to fetch, triage, implement, and resolve feedback
globs: .github/workflows/cursor-pr-review-agent.yml,.github/workflows/cursor-bot-pr-review-agent.yml,.github/scripts/address-review.ts,.github/scripts/build-pr-review-context.py,.github/scripts/build-pr-review-prompt.ts,.github/scripts/merge-review.ts,scripts/pr-check-comments.sh,scripts/pr-check-bot-comments.sh,scripts/pr-apply-comment-decisions.sh,scripts/pr-resolve-comments.sh,scripts/cursor-hooks/pr-review-check.ts,scripts/cli/git-utils.ts,scripts/__tests__/merge-review.test.ts,.cursor/commands/pr-review.md,.cursor/commands/pr-review-ai-bots.md
alwaysApply: false
---

# Automated Review Addressing System

## Introduction

### Purpose

The Automated Review Addressing System streamlines pull request reviews by automatically launching a Cursor Background Agent after feedback lands and pushing fixes directly to the PR's head branch. Human reviews trigger on submission; bot reviews trigger after CodeRabbit and Cursor Bugbot checks succeed or when maintainers add the `cursor-address-bot-review` label to force a run. Agents iterate on feedback in small batches and resolve review threads via repository-provided scripts, so developers do not have to merge mini PRs.

### Definitions

- **Background Agent**: A Cursor agent launched automatically for human reviews and for bot reviews after required checks succeed; it edits the PR head branch directly.
- **Review Batch**: A single GitHub review submission (human or AI bot) that may contain multiple inline comments.
- **Direct Branch Update**: The agent pushes commits to the PR head branch; no mini PR is opened.
- **Human Review Flow**: Automatically triggered for human review submissions; processes about seven comments per pass to keep context focused.
- **AI Bot Review Flow**: Automatically triggered after CodeRabbit and Cursor Bugbot checks succeed or when the `cursor-address-bot-review` label is applied; processes about five comments per pass and triages validity before applying updates.
- **Review Batch ID**: The numeric GitHub review identifier; used for context building and, when present, scoping human review fetches.
- **Manual Bot Trigger Label**: `cursor-address-bot-review` on a PR signals an intentional bot run even if required checks have not completed.

## Why Automated Review Addressing Exists

Manual triage of dense review batches slows down delivery and burdens reviewers with repetitive coordination. Automatically launching a Background Agent keeps PRs progressing: unresolved items are fetched and addressed in tight loops, small groups of comments are processed per pass, and the resulting commits land on the PR branch without extra merge steps. Bot reviews wait for CodeRabbit and Cursor Bugbot checks so all automated feedback is available before launching.

## How does this system make developers' lives easier?

- **Faster review turnaround**: For human reviews, an agent begins addressing comments immediately upon review submission.
- **Reduced toil**: Repetitive fetch/triage/resolve steps are automated using in-repo scripts and rules.
- **Direct branch updates**: Agents push fixes to the PR head branch; no mini PR needs to be merged.
- **Bot coverage without manual steps**: Bot reviews auto-launch after CodeRabbit and Cursor Bugbot checks finish so automated feedback is handled in one pass. Manual `/pr-review-ai-bots` and the `cursor-address-bot-review` label remain available when explicit instructions or overrides are needed.

## Directory Structure

```text
.github/
â”œâ”€â”€ workflows/
â”‚   â”œâ”€â”€ cursor-pr-review-agent.yml        # Launches Background Agent on pull_request_review: submitted (human reviews)
â”‚   â””â”€â”€ cursor-bot-pr-review-agent.yml    # Launches Background Agent after CodeRabbit + Cursor Bugbot checks succeed
â””â”€â”€ scripts/
    â”œâ”€â”€ address-review.ts                  # Local CLI to replicate cloud agent setup
    â”œâ”€â”€ build-pr-review-context.py        # Gathers structured context for agent prompts
    â”œâ”€â”€ build-pr-review-prompt.ts         # Constructs agent prompt with dynamic task sizing
    â””â”€â”€ merge-review.ts                   # Merges review branches back into base with optional commit message

scripts/
â”œâ”€â”€ cursor-hooks/
â”‚   â”œâ”€â”€ pr-review-check.ts                # Detects PR review branches, checks for unresolved comments
â”‚   â””â”€â”€ agent-check.ts                    # Orchestrates all stop-time checks including PR review
â”œâ”€â”€ cli/
â”‚   â””â”€â”€ git-utils.ts                      # Git CLI utilities for branch/PR operations
â”œâ”€â”€ pr-check-comments.sh                  # Fetch unresolved human comments via GitHub GraphQL API
â”œâ”€â”€ pr-check-bot-comments.sh              # Fetch unresolved bot comments
â”œâ”€â”€ pr-apply-comment-decisions.sh         # Apply reactions and resolve threads for bot comments
â””â”€â”€ pr-resolve-comments.sh                # Resolve review threads directly

.cursor/commands/
â”œâ”€â”€ pr-review.md                          # Command playbook for human reviews
â””â”€â”€ pr-review-ai-bots.md                  # Command playbook for AI bot reviews
```

## Core Components

- **Workflows**: `cursor-pr-review-agent.yml` launches on `pull_request_review: submitted` for human reviews; `cursor-bot-pr-review-agent.yml` launches after CodeRabbit and Cursor Bugbot check runs succeed or when the `cursor-address-bot-review` label is applied to a PR.
- **Context Builders**: `build-pr-review-context.py` and `build-pr-review-prompt.ts` assemble PR metadata, review/bot context, and unresolved comments into the agent prompt.
- **Fetch Scripts**: `pr-check-comments.sh` and `pr-check-bot-comments.sh` pull unresolved threads (human vs bot) with batching and bot filtering controls.
- **Cursor Hooks**: `scripts/cursor-hooks/pr-review-check.ts` plus `agent-check.ts` enforce unresolved-comment gating, then run build/lint/test/structure checks before agents can stop.
- **CLI**: `scripts/address-review.ts` mirrors the cloud flow locally: infers PR, fetches comments, builds prompt, and sets up the working branch.
- **Merge helper**: `.github/scripts/merge-review.ts` parses review branch names, stages pending changes with an optional or default commit message, checks out the base branch (local or inferred from the PR), and merges the review branch without opening a new PR.
- **Commands**: `.cursor/commands/pr-review.md` and `.cursor/commands/pr-review-ai-bots.md` provide manual playbooks when automation is skipped or extra guidance is needed.

## How It Works

### 1) Launch on Review Submission

When a review is submitted on a PR, `.github/workflows/cursor-pr-review-agent.yml` executes:

- Runs Python context builder (`.github/scripts/build-pr-review-context.py`) to gather PR metadata, review metadata, determine bot status, and fetch CodeRabbit summary.
- **For human reviews**: Automatically launches a Background Agent to address comments on the PR head branch (no mini PR).
- **For bot reviews**: Skips automatic launch here; the bot workflow below handles automation. Manual `/pr-review-ai-bots` remains available for explicit instructions.
- Builds a structured prompt file embedding the JSON context and inline instructions.
- Calls the Cursor Background Agent API with repository/ref set to the PR head branch, `autoCreatePr: false`, and the configured model.
- Posts a PR review comment with a link to the agent run for visibility.

### 1b) Launch on Bot Checks

When CodeRabbit and Cursor Bugbot checks both succeed for a PR head SHA, `.github/workflows/cursor-bot-pr-review-agent.yml` executes. The same workflow also runs when a maintainer applies the `cursor-address-bot-review` label to a PR, which serves as a manual override and skips the required-check gate:

- Confirms both check runs (by app slug/name) have `conclusion: success` on the PR head SHA unless the manual override label is present.
- Fetches unresolved bot comments (limit 5) and builds a synthetic bot review context plus prompt.
- Launches a Cursor Background Agent on the PR head branch (`autoCreatePr: false`).
- Posts a PR comment with the agent link.

### 2) Agent Iteration Loop

Inside the agent session, the agent follows inline instructions embedded in the prompt:

- **Human review flow** (automatic): The agent receives ~7 unresolved comments in the initial prompt and, on each stop attempt, receives additional unresolved comments via Cursor stop-hook followups. It processes comments, implements edits, and resolves completed threads with `npm run resolve-comments -- <comment_url_1> <comment_url_2> ...`.
- **AI bot review flow** (automatic or manual): The bot workflow auto-launches after CodeRabbit and Cursor Bugbot checks succeed (or you can invoke `/pr-review-ai-bots`). The agent receives ~5 unresolved bot comments, triages validity, generates `decisions.json`, and runs `npm run apply-comment-decisions -- .cursor/tmp/decisions.json` to react and resolve threads.
- Agents commit directly to the PR head branch; no mini PR is created.
- **Note**: The agent does not need to fetch comments manually; the stop hook automatically fetches and presents unresolved comments when the agent attempts to stop.

### 3) Stop Hook Integration

When the agent attempts to stop, the stop hook (`scripts/cursor-hooks/agent-check.ts`) executes:

- Calls `performPrReviewCheck()` from `pr-review-check.ts` BEFORE running build/lint/test checks (priority 1).
- `performPrReviewCheck()` extracts PR number and review batch from branch patterns when present, otherwise falls back to the open PR for the current branch to keep direct-branch agents in the loop.
- Determines bot vs human review (by review batch when available, otherwise by checking unresolved bot comments first).
- Runs the appropriate fetch script (`fetch-unresolved-comments` or `fetch-unresolved-bot-comments`) to check for remaining comments.
- If comments remain, returns a followup message with:
  - The full markdown checklist of unresolved comments
  - Resolution instructions specific to review type
  - The agent cannot stop until all comments are resolved.
- If no comments remain, allows the agent to proceed to build/lint/test checks.

**Execution Order**: PR review comment check â†’ build â†’ linting â†’ tests â†’ rule structure validation â†’ check-your-work. This prioritizes completing all reviewer feedback before enforcing code quality checks.

## How to Use the System

### Human Review Batches

1. Submit a standard GitHub review with inline comments.
2. Wait for the PR comment confirming that a Background Agent was launched. Follow the link to monitor it.
3. The agent processes ~7 comments per pass and pushes commits directly to the PR branch.
4. If needed, run locally:
   - Fetch unresolved: `npm run fetch-unresolved-comments -- --pr=<PR_NUMBER> [--review-batch=<REVIEW_ID>]`
   - Resolve threads: `npm run resolve-comments -- <comment_url_1> <comment_url_2> ...`

### AI Bot Review Batches (CodeRabbit, Graphite, Cursor BugBot, etc.)

1. Submit or trigger CodeRabbit and Cursor Bugbot checks.
2. After both checks succeed, a Background Agent launches automatically. Follow the PR comment to monitor it. Use `/pr-review-ai-bots` manually if you want to provide explicit instructions or skip automation.
3. The agent triages validity, processes ~5 comments at a time, and resolves valid items with `apply-comment-decisions`, pushing fixes directly to the PR branch.
4. If needed, run locally:
   - Fetch unresolved: `npm run fetch-unresolved-bot-comments -- --pr=<PR_NUMBER> [--review-batch=<REVIEW_ID>]`
   - Apply decisions: `npm run apply-comment-decisions -- .cursor/tmp/decisions.json [--pr=<PR_NUMBER>]`

**Note**: Automatic mini-PRs are disabled for bot reviews to prevent clutter and reduce costs.

### Merging review branches

Use the merge helper when finishing a review branch that follows the `(<base>)-review-pr-(<pr>)[-(<reviewBatch>)][-(human|bot)]` pattern:

- Run on the review branch: `npm run merge-review -- --message "<optional_commit_message>"`
- The helper stages all changes, commits with the provided message or `chore: merge review branch for PR #<pr> [(review <reviewBatch>)]`, checks out the base branch (local match or inferred from the PR), and merges the review branch.
- Ensure the branch name matches the pattern so the base branch candidate and PR number resolve correctly.

### Tips

- **For bot reviews**: Before using `/pr-review-ai-bots`, mark invalid comments with a ðŸ‘Ž reaction and resolve them. This prevents the agent from fetching them.
- Bot automation runs after CodeRabbit and Cursor Bugbot checks succeed; the `cursor-address-bot-review` label can force a launch when those checks are not yet green.
- Agents push directly to the PR branch; watch the PR commits tab for updates.
- You can still use `.cursor/commands/pr-review.md` or `.cursor/commands/pr-review-ai-bots.md` manually in Cursor Chat for follow-ups.

## Local Development Workflow

Developers can replicate the cloud agent setup locally using the `address-review` npm script:

```bash
# Auto-detect PR from current branch, process all unresolved comments
npm run address-review

# Specify PR explicitly
npm run address-review -- --pr=123

# Process specific review batch (PR inferred from current branch)
npm run address-review -- --review-batch=456789

# Process specific review batch with explicit PR
npm run address-review -- --pr=123 --review-batch=456789

# Force bot review workflow (overrides auto-detection)
npm run address-review -- --pr=123 --review-batch=456789 --force-bot

# Force human review workflow (overrides auto-detection)
npm run address-review -- --pr=123 --review-batch=456789 --force-human
```

### What the Script Does

1. **Validates Prerequisites**: Checks that `gh`, `jq`, and `git` are installed and working directory is clean
2. **Infers Context**: Auto-detects PR number from current branch if not provided
3. **Builds Review Context**: Gathers PR metadata, review metadata, determines bot vs. human review
4. **Fetches Unresolved Comments**: Runs the appropriate bash script to get the checklist
5. **Builds Agent Prompt**: Uses the same prompt builder as the cloud workflow
6. **Creates Review Branch**: Checks out a new branch following the naming pattern
7. **Writes Prompt File**: Saves the complete prompt to `.cursor/tmp/pr-review-prompt.md`
8. **Provides Instructions**: Displays next steps for opening Cursor Chat

### After Running the Script

1. Open the prompt file at `.cursor/tmp/pr-review-prompt.md`
2. Copy its entire contents
3. Open a new Cursor Composer conversation
4. Paste the prompt and start the agent

The agent follows the same workflow as a cloud agentâ€”the stop hook automatically presents new unresolved comments when the agent attempts to finish.

### Prerequisites

- **GitHub CLI (`gh`)**: Authenticated with appropriate repository permissions
- **jq**: JSON parsing utility for processing GitHub API responses
- **git**: Clean working directory (no uncommitted changes)

## Configuration

### GitHub Action Secrets

| Secret | Purpose |
|--------|---------|
| `CURSOR_API_KEY` | Cursor API authentication for background agents |
| `GITHUB_TOKEN` | Auto-provided, used for PR/issue operations |

### npm Scripts

| Script | Purpose |
|--------|---------|
| `npm run address-review` | Local CLI to set up PR review workflow |
| `npm run fetch-unresolved-comments` | Fetch unresolved human review comments |
| `npm run fetch-unresolved-bot-comments` | Fetch unresolved bot review comments |
| `npm run resolve-comments` | Resolve review threads by URL |
| `npm run apply-comment-decisions` | Apply reactions and resolve bot comment threads |
| `npm run merge-review` | Commit staged changes on a review branch and merge into the inferred base branch |

## Critical Insights for Maintainers

- **Bot gating is deliberate**: Bot agents launch only after both CodeRabbit and Cursor Bugbot checks succeed to ensure all automated feedback is present and avoid redundant runs; `/pr-review-ai-bots` and the `cursor-address-bot-review` label are available when a manual launch is intentional.
- **Batch sizing balances load**: ~7 items for human reviews maximizes throughput with manageable context; ~5 items for bot reviews limits triage overhead because bot feedback often mixes valid and invalid findings.
- **Direct branch commits reduce friction**: Agents push to the PR head branch (no mini PR) to avoid merge overhead and keep review threads resolvable on the original branch.
- **Branch detection fallback**: When no `-review-pr-*` suffix exists (direct-branch automation), `pr-review-check.ts` falls back to the open PR for the current branch and still blocks completion until unresolved comments are cleared.
- **Merge helper expectations**: `merge-review.ts` requires the review branch naming pattern to extract the PR number and base candidate; if the base branch is missing locally it falls back to the PR head name. It stages all working tree changes before merging and uses a generated commit message when none is provided.
- **Future improvements**: Consider sourcing the required bot check names from repo settings instead of hard-coding CodeRabbit/Cursor, and expose a config flag to change bot batch size when feedback volume is higher.

## Common Pitfalls

- Bot automation waits for both CodeRabbit and Cursor Bugbot checks to finish successfully; if one is missing, the bot agent will not launch.
- The manual override label bypasses required-check gating; apply it only when a forced bot pass is desired and when unresolved bot feedback is present.
- The CLI review scripts require both `gh` and `jq` in the execution environment.
- The agent does not need to fetch comments manually; the stop hook handles this automatically.
- For manual runs, you can still use `.cursor/commands/pr-review.md` or `.cursor/commands/pr-review-ai-bots.md` in Cursor Chat.

## Relationship to Other Systems

This system integrates with the **Cursor Hooks and Workflows System** documented in `cursor-hooks-and-workflows.mdc`. The PR review check runs as the first priority in the stop hook execution order, before build/lint/test checks. This ensures all reviewer feedback is addressed before code quality enforcement.
