---
description: Cursor Hooks and GitHub Workflows for automated ESLint rule development
globs: scripts/cursor-hooks/**/*.ts,.github/workflows/cursor-*.yml,.cursor/hooks/**/*
alwaysApply: false
---

# Cursor Hooks and GitHub Workflows System

## Purpose

This system automates the ESLint rule development lifecycle using **Cursor Hooks** for local quality enforcement and **GitHub Workflows** for triggering Cursor Background Agents on issue events.

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            GitHub Issue Created                              │
│                          (with rule-request label)                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│               cursor-rule-research-agent.yml (cursor-research)               │
│     • Searches web for existing ESLint rules                                 │
│     • Posts findings as issue comment                                        │
│     • Labels: research-complete, cursor-implement (if NO MATCH)              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                        (if NO MATCH → cursor-implement)
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│             cursor-implement-rule-agent.yml (cursor-implement)               │
│     • Creates new branch from develop                                        │
│     • Implements rule using .cursor/commands/implement-rule.md              │
│     • Cursor Hooks enforce quality (build, lint, tests, structure)          │
│     • Opens PR on completion                                                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Definitions

| Term | Description |
|------|-------------|
| **Cursor Hook** | Script executed at agent lifecycle events (stop, afterFileEdit, beforeSubmitPrompt) |
| **Stop Hook** | Prevents agent completion until quality checks pass |
| **Rule Request Flag** | `<!-- rule-request -->` marker that triggers expanded test prompts |
| **Change Log** | JSON file tracking modified files per conversation/generation |
| **MAX_LOOPS** | Safety limit (10) preventing infinite validation loops |

## Directory Structure

```
.cursor/
├── hooks.json                           # Hook configuration
├── hooks/
│   ├── stop.sh                          # Stop hook entry point
│   ├── track-changes.sh                 # File change tracking
│   └── track-prompt.sh                  # Prompt tracking & rule-request detection
├── commands/
│   ├── implement-rule.md                # New rule implementation guide
│   └── fix-bug.md                       # Bug fix guide
├── rules/
│   ├── task-completion-standards.mdc    # Quality checklist
│   └── cursor-hooks-and-workflows.mdc   # This documentation
└── tmp/
    └── hooks/
        └── agent-change-log.json        # Auto-created change log

scripts/
├── cursor-hooks/
│   ├── agent-check.ts                   # Main stop hook logic
│   ├── change-log.ts                    # Change log utilities
│   ├── lint-diff.ts                     # Lint changed files only
│   ├── pr-review-check.ts               # PR review comment check for stop hook
│   ├── track-changes.ts                 # Track file modifications
│   ├── track-prompt.ts                  # Track prompts & detect flags
│   ├── types.ts                         # Shared TypeScript types
│   └── validate-rule-structure.ts       # Validate rule has all files
├── cli/
│   └── git-utils.ts                     # Git CLI utilities
└── github/
    └── post-research-comment.ts         # Post research findings to issue

.github/workflows/
├── cursor-rule-research-agent.yml       # Research existing rules
├── cursor-implement-rule-agent.yml      # Implement new rules
└── cursor-fix-bug-agent.yml             # Fix bugs in rules
```

## GitHub Labels

| Label | Purpose |
|-------|---------|
| `rule-request` | New ESLint rule request |
| `bug` | Bug in existing rule |
| `cursor-research` | Triggers research workflow |
| `research-complete` | Research has been performed |
| `cursor-implement` | Triggers implementation workflow |
| `cursor-fix` | Triggers bug fix workflow |

## Workflow Details

### 1. Research Workflow (`cursor-rule-research-agent.yml`)

**Trigger**: Issue labeled with `cursor-research`

**Purpose**: Search for existing ESLint rules before implementing

**Flow**:
1. Check if research comment already exists (short-circuit)
2. Launch Cursor Background Agent to search web
3. Agent writes findings to `.cursor/tmp/research-results.md`
4. Agent runs `post-research-comment.ts` which:
   - Posts findings as issue comment
   - Removes `cursor-research` label
   - Adds `research-complete` label
   - If NO MATCH: Adds `cursor-implement` label

### 2. Implementation Workflow (`cursor-implement-rule-agent.yml`)

**Trigger**: Issue labeled with `cursor-implement` (requires `rule-request` + `research-complete`)

**Purpose**: Implement new ESLint rule

**Flow**:
1. Create branch: `develop-implement-rule-{issue_number}`
2. Build prompt from `.cursor/commands/implement-rule.md` + issue body
3. Include `<!-- rule-request -->` flag for expanded test prompts
4. Launch Cursor Background Agent
5. Cursor Hooks enforce quality until completion
6. Open PR targeting `develop`

### 3. Bug Fix Workflow (`cursor-fix-bug-agent.yml`)

**Trigger**: Issue labeled with `cursor-fix` (requires `bug`)

**Purpose**: Fix bugs in existing rules

**Flow**:
1. Create branch: `develop-fix-bug-{issue_number}`
2. Build prompt from `.cursor/commands/fix-bug.md` + issue body
3. No `<!-- rule-request -->` flag (skip expanded test prompts)
4. Launch Cursor Background Agent
5. Cursor Hooks enforce quality until completion
6. Open PR targeting `develop`

## Cursor Hooks System

### Hook Configuration (`.cursor/hooks.json`)

```json
{
  "version": 1,
  "hooks": {
    "afterFileEdit": [{ "command": ".cursor/hooks/track-changes.sh" }],
    "beforeSubmitPrompt": [{ "command": ".cursor/hooks/track-prompt.sh" }],
    "stop": [{ "command": ".cursor/hooks/stop.sh" }]
  }
}
```

### Stop Hook Execution Order

1. **Heartbeat Update**: Record activity timestamp
2. **Status Check**: Skip checks if agent status is not `completed`
3. **PR Review Check**: For PR review branches (`*-review-pr-*`), check for unresolved comments (see `automated-review-addressing.mdc`)
4. **Build Validation**: `npm run build` must succeed
5. **Linting Validation**: ESLint on changed files only
6. **Test Validation**: `npm test` must pass
7. **Rule Structure Validation**: For rule implementations, verify:
   - `src/rules/{rule-name}.ts` exists
   - `src/tests/{rule-name}.test.ts` exists
   - `docs/rules/{rule-name}.md` exists
   - `src/index.ts` updated in 3 places (import, config, rules)
   - `README.md` mentions the rule
8. **Check-Your-Work Prompt**: Self-review prompt
9. **Expand Tests Prompt**: For rule implementations only (requires 20+ tests)

#### Critical Insights for Maintainers

- Order is fail-fast by design: stop on build errors before lint/test to avoid long runs when TypeScript cannot compile.
- Common pain points: flaky tests or slow lint/test runs can loop; rerun locally with the same commands in stop.sh and scope to changed files when possible.
- Rule structure validation loops if required files are missing or src/index.ts exports are incomplete; ensure all items in the checklist above exist before reruns.
- MAX_LOOPS in change-log.ts (surfaced via .cursor/hooks.json) prevents infinite prompting; increase only when intentionally allowing longer runs.
- Hook side-effects cascade: PR review checks can short-circuit quality checks, and change-log updates influence later prompts; watch the console output to see which stage stopped the run.

### Rule Request Detection

The `<!-- rule-request -->` flag in the first prompt marks conversations as rule implementations:

```typescript
function detectRuleRequestFlag(prompt: string): boolean {
  return prompt.includes('<!-- rule-request -->');
}
```

This triggers the "Expand Tests" prompt after the first "Check Your Work" prompt.

### Change Log Structure

`.cursor/tmp/hooks/agent-change-log.json`:

```json
{
  "conversation-123": {
    "_metadata": {
      "hasCheckWorkPrompted": true,
      "hasExpandTestsPrompted": false,
      "isRuleRequest": true,
      "lastUserMessage": "...",
      "endTimestamp": null,
      "lastActivityTimestamp": 1700000100000
    },
    "generation-456": ["src/rules/new-rule.ts", "src/tests/new-rule.test.ts"]
  }
}
```

## Quality Enforcement

### Required Files for New Rules

1. `src/rules/{rule-name}.ts` - Rule implementation
2. `src/tests/{rule-name}.test.ts` - Test suite (20+ tests required)
3. `docs/rules/{rule-name}.md` - Documentation
4. `src/index.ts` updates:
   - Import statement
   - `configs.recommended.rules` entry
   - `rules` object entry
5. `README.md` mention

### Test Requirements

- Minimum 20 tests per rule
- 10+ valid cases (code that should NOT trigger)
- 10+ invalid cases (code that SHOULD trigger)
- Edge cases from issue specification
- Auto-fix tests if rule has `fixable: 'code'`

## Loop Prevention

The system uses `MAX_LOOPS = 10` to prevent infinite loops. After 10 iterations, agents complete even if checks fail.

## GitHub Secrets Required

| Secret | Purpose |
|--------|---------|
| `CURSOR_API_KEY` | Cursor API authentication for background agents |
| `GITHUB_TOKEN` | Auto-provided, used for issue/PR operations |

## Common Issues

### Agent Stuck in Loop

If an agent keeps failing the same check:
- Check the error output in the agent conversation
- The agent will auto-stop after MAX_LOOPS (10) iterations
- Review the failing validation and fix manually if needed

### Research Workflow Not Triggering

- Ensure issue has `cursor-research` label
- Check if research comment already exists (short-circuit logic)
- Verify `CURSOR_API_KEY` secret is configured

### Implementation Workflow Not Triggering

- Requires all three labels: `rule-request`, `research-complete`, `cursor-implement`
- Research workflow auto-adds `cursor-implement` only on NO MATCH
- For MATCH cases, human must decide to proceed

### Structure Validation Failing

Common mistakes:
1. Missing import in `src/index.ts`
2. Missing entry in `configs.recommended.rules`
3. Missing entry in `rules` object
4. Documentation not created
5. README not updated

## Edge Cases and Known Limitations

### Research Finds Multiple Partial Matches

When research discovers multiple rules that partially address the requirement, the agent documents all options in the research comment. A human must then decide whether to:
- Use an existing partial match with configuration adjustments
- Combine multiple existing rules
- Proceed with a new custom implementation

### Rule Name Conflicts

The `validate-rule-structure.ts` script checks for existing rules with the same name to prevent accidental overwrites. If a conflict is detected, the agent receives a warning message.

### Flaky Tests

The test validation runs `npm test` which may occasionally fail due to flaky tests. The MAX_LOOPS mechanism allows agents to eventually complete after 10 attempts. For persistent flaky tests, manual intervention may be required.

### Complex Rules with Helper Utilities

Some rules require additional helper utilities beyond the standard 3-file structure. The validation is flexible enough to allow additional files, but agents should ensure helpers are properly documented.

### Research Results Without Clear Recommendation

If the research agent produces results that don't clearly indicate EXACT MATCH, PARTIAL MATCH, or NO MATCH, the `post-research-comment.ts` script posts a warning comment asking for manual review.

## Security Considerations

### GitHub Token Scope

The workflows use `GITHUB_TOKEN` (auto-provided by GitHub Actions) for:
- Reading issue details
- Posting comments
- Modifying labels
- Creating pull requests

Ensure the repository settings allow the `GITHUB_TOKEN` to have write permissions for issues and pull requests.

### Cursor API Key

The `CURSOR_API_KEY` must be stored as a GitHub secret. Never expose this key in logs or error messages. The workflows mask this value automatically.

## Performance Considerations

### Short-Circuit Logic

The research workflow checks for existing research comments before launching an agent. This prevents duplicate research runs and reduces API costs.

### Linting Scope

The `lint-diff.ts` script only lints files changed in the current generation, not the entire codebase. This improves performance and avoids unrelated errors.

### Rate Limiting

GitHub workflow concurrency groups prevent overlapping runs for the same issue:
- `cursor-research-${{ github.event.issue.number }}`
- `cursor-implement-${{ github.event.issue.number }}`
- `cursor-fix-${{ github.event.issue.number }}`

If many issues are labeled simultaneously, each will be processed sequentially per-issue.

## Development Tips

### Running Hooks Locally

```bash
# Test stop hook
echo '{"conversation_id":"test","generation_id":"test","loop_count":0,"status":"completed"}' | npx tsx scripts/cursor-hooks/agent-check.ts

# Test lint-diff
npx tsx scripts/cursor-hooks/lint-diff.ts --conversation-id "test" --generation-id "test"

# Test validate-rule-structure
node -e "const {validateRuleStructure} = require('./scripts/cursor-hooks/validate-rule-structure'); console.log(validateRuleStructure('my-rule-name'));"
```

### Debugging Change Log

```bash
# View current change log
cat .cursor/tmp/hooks/agent-change-log.json | jq .

# Clear change log (for testing)
rm .cursor/tmp/hooks/agent-change-log.json
```

### Testing Workflows Locally

Use [act](https://github.com/nektos/act) to test GitHub workflows locally:

```bash
# Create test event file
cat > test-event.json << 'EOF'
{
  "action": "labeled",
  "label": { "name": "cursor-research" },
  "issue": { "number": 123, "title": "Test Rule", "body": "Test body" }
}
EOF

# Run workflow
act issues -e test-event.json
```

### Verifying Script Execution

```bash
# Ensure shell scripts are executable
chmod +x .cursor/hooks/*.sh

# Test shell script directly
echo '{"conversation_id":"test","generation_id":"test","workspace_roots":["/path/to/repo"]}' | .cursor/hooks/stop.sh
```
