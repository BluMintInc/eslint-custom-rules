name: Launch Cursor Agent on Bot Checks

on:
  check_run:
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  launch_bot_agent:
    if: ${{ github.event.check_run.pull_requests[0].number }}
    runs-on: ubuntu-latest
    concurrency:
      group: cursor-bot-review-${{ github.event.check_run.pull_requests[0].head.sha || github.run_id }}
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Determine required checks completion
        id: checks
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          PR_NUMBER='${{ github.event.check_run.pull_requests[0].number }}'
          HEAD_SHA='${{ github.event.check_run.pull_requests[0].head.sha }}'
          HEAD_REF='${{ github.event.check_run.pull_requests[0].head.ref }}'

          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "head_sha=$HEAD_SHA" >> "$GITHUB_OUTPUT"
          echo "head_ref=$HEAD_REF" >> "$GITHUB_OUTPUT"

          # Fetch all check runs for this head SHA
          CHECKS_JSON=$(gh api -H "Accept: application/vnd.github+json" "/repos/${{ github.repository }}/commits/$HEAD_SHA/check-runs")

          has_cursor=$(echo "$CHECKS_JSON" | jq 'any(.check_runs[]; ((.app.slug|ascii_downcase|test("cursor")) or (.name|test("Cursor Bugbot";"i"))) and .status == "completed" and .conclusion == "success")')
          has_coderabbit=$(echo "$CHECKS_JSON" | jq 'any(.check_runs[]; ((.app.slug|ascii_downcase|test("coderabbit")) or (.name|test("CodeRabbit";"i"))) and .status == "completed" and .conclusion == "success")')

          if [ "$has_cursor" != "true" ] || [ "$has_coderabbit" != "true" ]; then
            echo "missing_required=true" >> "$GITHUB_OUTPUT"
            echo "Required bot checks not yet successful (CodeRabbit & Cursor Bugbot). Skipping launch."
          else
            echo "missing_required=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip if required checks missing
        if: steps.checks.outputs.missing_required == 'true'
        run: echo "Waiting for required bot checks to succeed before launching agent."

      - name: Fetch unresolved bot comments
        id: comments
        if: steps.checks.outputs.missing_required != 'true'
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          PR=${{ steps.checks.outputs.pr_number }}
          COMMENTS=$(./scripts/pr-check-bot-comments.sh --pr="$PR" --limit=5)
          echo "$COMMENTS" > /tmp/pr-review-comments.md

          COUNT=$(echo "$COMMENTS" | awk '/^[0-9]+\. \[ \] /{c++} END{print c+0}')
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"
          echo "comments_path=/tmp/pr-review-comments.md" >> "$GITHUB_OUTPUT"

          if [ "$COUNT" -eq 0 ]; then
            echo "no_comments=true" >> "$GITHUB_OUTPUT"
          else
            echo "no_comments=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Exit if no bot comments
        if: steps.comments.outputs.no_comments == 'true'
        run: echo "No unresolved bot comments; skipping agent launch."

      - name: Build bot review context and prompt
        id: prompt
        if: steps.comments.outputs.no_comments != 'true'
        run: |
          PR=${{ steps.checks.outputs.pr_number }}
          HEAD_REF='${{ steps.checks.outputs.head_ref }}'
          COMMENT_COUNT='${{ steps.comments.outputs.count }}'

          PR_JSON=$(gh pr view "$PR" --json number,title,body,headRefName,baseRefName,url)

          jq -n \
            --arg pr_number "$(echo "$PR_JSON" | jq -r '.number')" \
            --arg pr_title "$(echo "$PR_JSON" | jq -r '.title')" \
            --arg pr_body "$(echo "$PR_JSON" | jq -r '.body // ""')" \
            --arg pr_head "$(echo "$PR_JSON" | jq -r '.headRefName')" \
            --arg pr_base "$(echo "$PR_JSON" | jq -r '.baseRefName')" \
            --arg pr_url "$(echo "$PR_JSON" | jq -r '.url')" \
            --argjson comment_count "$COMMENT_COUNT" \
            '{
              pr: {
                number: ($pr_number|tonumber),
                title: $pr_title,
                head_branch: $pr_head,
                base_branch: $pr_base,
                description: $pr_body,
                url: $pr_url
              },
              review: {
                id: 0,
                author: "CodeRabbit and Cursor bot checks",
                author_type: "Bot",
                is_bot: true,
                comment_count: $comment_count
              },
              coderabbit_summary: "(Auto-launched after CodeRabbit and Cursor bot checks succeeded)"
            }' > /tmp/pr-review-context.json

          npx tsx .github/scripts/build-pr-review-prompt.ts /tmp/pr-review-context.json /tmp/pr-review-comments.md > /tmp/pr-review-prompt.txt

          echo "context_path=/tmp/pr-review-context.json" >> "$GITHUB_OUTPUT"
          echo "prompt_path=/tmp/pr-review-prompt.txt" >> "$GITHUB_OUTPUT"

      - name: Launch Cursor Background Agent for bot comments
        id: launch
        if: steps.comments.outputs.no_comments != 'true'
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          CURSOR_WEBHOOK_SECRET: ${{ secrets.CURSOR_WEBHOOK_SECRET }}
          CURSOR_WEBHOOK_URL: ${{ secrets.CURSOR_WEBHOOK_URL }}
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          JSON_PAYLOAD=$(jq -n \
            --rawfile prompt_text /tmp/pr-review-prompt.txt \
            --arg repository "https://github.com/${{ github.repository }}" \
            --arg source_ref "${{ steps.checks.outputs.head_ref }}" \
            --arg target_branch "${{ steps.checks.outputs.head_ref }}" \
            --arg webhook_url "${CURSOR_WEBHOOK_URL}" \
            --arg webhook_secret "${CURSOR_WEBHOOK_SECRET}" \
            --arg model "gpt-5.1-codex-max-high" \
            '{
              model: $model,
              prompt: { text: $prompt_text },
              source: { repository: $repository, ref: $source_ref },
              target: { branchName: $target_branch, autoCreatePr: false, skipReviewerRequest: true },
              webhook: { url: $webhook_url, secret: $webhook_secret }
            }')

          HTTP_RESPONSE=$(curl --silent --show-error --write-out "HTTPSTATUS:%{http_code}" \
            --request POST \
            --url https://api.cursor.com/v0/agents \
            --header "Authorization: Bearer ${CURSOR_API_KEY}" \
            --header "Content-Type: application/json" \
            --data "$JSON_PAYLOAD")

          HTTP_STATUS="${HTTP_RESPONSE##*HTTPSTATUS:}"
          HTTP_BODY="${HTTP_RESPONSE%HTTPSTATUS:*}"

          echo "Cursor API HTTP status: $HTTP_STATUS"
          echo "Cursor API response body (raw):"
          if ! echo "$HTTP_BODY" | jq '.'; then
            echo "$HTTP_BODY"
          fi

          if [[ "$HTTP_STATUS" =~ ^2 ]]; then
            AGENT_URL=$(echo "$HTTP_BODY" | jq -r '.target.url // empty')
            echo "agent_url=$AGENT_URL" >> $GITHUB_OUTPUT
            echo "launched=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::Cursor API returned status $HTTP_STATUS. See response body above for details."
            echo "agent_url=" >> $GITHUB_OUTPUT
            echo "launched=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        if: steps.launch.outputs.launched == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          URL='${{ steps.launch.outputs.agent_url }}'
          PR=${{ steps.checks.outputs.pr_number }}
          gh pr comment "$PR" --body "âœ… Launched Cursor agent to address bot review comments after CodeRabbit and Cursor Bugbot checks passed. Agent: $URL. Changes are pushed directly to this PR branch."

